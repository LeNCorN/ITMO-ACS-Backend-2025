POSTMAN_API_KEY := $(POSTMAN_API_KEY)
COLLECTION_UID := $(COLLECTION_UID)

# swagger.json:
# 	curl http://localhost:3000/swagger.json -o swagger.json

# postman.json: swagger.json
# 	openapi2postmanv2 -s swagger.json -o postman.json -p

# wrap:
# 	jq '{ collection: . }' postman.json > wrapped-postman.json

# sync: swagger.json
# 	openapi2postmanv2 -s swagger.json -o postman.json -p
# 	jq '{ collection: . }' postman.json > wrapped-postman.json
# 	curl -X PUT https://api.getpostman.com/collections/$(COLLECTION_UID) \
# 	  -H "X-Api-Key: $(POSTMAN_API_KEY)" \
# 	  -H "Content-Type: application/json" \
# 	  -d @wrapped-postman.json

# clean:
# 	rm -f swagger.json postman.json wrapped-postman.json


# === –°–ø–∏—Å–æ–∫ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–æ–≤ ===
SERVICES = auth-service workout-service progress-service order-service blog-service

# === –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ ===
run:
	@for service in $(SERVICES); do \
		echo "‚ñ∂ Starting $$service..."; \
		cd $$service && pnpm dev & cd ..; \
	done

# === –ó–∞–ø—É—Å–∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞ ===
run-%:
	@echo "‚ñ∂ Starting $*..."
	cd $*-service && pnpm dev

# === –°–±–æ—Ä–∫–∞ –≤—Å–µ—Ö TS –ø—Ä–æ–µ–∫—Ç–æ–≤ ===
build:
	@for service in $(SERVICES); do \
		echo "üî® Building $$service..."; \
		cd $$service && pnpm build && cd ..; \
	done

# === –ü—Ä–æ–≥–æ–Ω –º–∏–≥—Ä–∞—Ü–∏–π ===
migrate:
	@for service in $(SERVICES); do \
		echo "üì¶ Running migrations for $$service..."; \
		cd $$service && pnpm migration:run && cd ..; \
	done

# === –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –º–∏–≥—Ä–∞—Ü–∏–π (—Ç–æ–ª—å–∫–æ –¥–ª—è –æ–¥–Ω–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞!) ===
gen-migration-%:
	@echo "‚öôÔ∏è Generating migration for $*..."
	cd $*-service && pnpm migration:generate

# === –£–¥–∞–ª–µ–Ω–∏–µ node_modules + dist + –ª–æ–≥–æ–≤
clean:
	@for service in $(SERVICES); do \
		echo "üßπ Cleaning $$service..."; \
		rm -rf $$service/node_modules $$service/dist; \
	done

# === –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
install:
	@for service in $(SERVICES); do \
		echo "üì¶ Installing dependencies for $$service..."; \
		cd $$service && pnpm install && cd ..; \
	done
